<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" type="image/png" sizes="16x16" href="/static/img/favicon.ico" />
	<title>数据质量检核平台</title>


	<link rel="stylesheet" type="text/css" href="/static/check/css/admin/bootstrap.min.css"/>
	<link rel="stylesheet" type="text/css" href="/static/check/css/admin/style.css"/>
	<link rel="stylesheet" type="text/css" href="/static/CodeMirror/lib/codemirror.css"/>
	<link rel="stylesheet" type="text/css" href="/static/CodeMirror/theme/eclipse.css"/>
	<link rel="stylesheet" type="text/css" href="/static/css/sweetalert.css"/>
	<link href="https://cdn.bootcss.com/bootstrap-select/2.0.0-beta1/css/bootstrap-select.min.css" rel="stylesheet">


	<style>
		.modal.fade.in{
			top: 180px;
		}
		.table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
			vertical-align: middle;
		}
		.btn-default:hover, .btn-default:focus, .btn-default:active, .btn-default.active, .open .dropdown-toggle.btn-default {
			background-color: unset;
			border-color: unset;
			color: unset;
		}
		.btn-default.active, .btn-default.focus, .btn-default:active, .btn-default:focus, .btn-default:hover, .open>.dropdown-toggle.btn-default {
			background-color: unset;
			border-color: unset;
			color: unset;
		}
	</style>
</head>

<body>
	<!-- head star -->
	<div class="tnav row wrapper border-bottom white-bg page-heading">
		<div class="col-sm-4">
			<h2 class="fl" style="color: #007bff;font-size: 21px;font-weight:500">数据质量检核规则库</h2>
			<ol class="breadcrumb fl">
				<li><a href="../../data/index">主页</a></li>
				<li><strong>检核规则库</strong></li>
			</ol>
		</div>
	</div>
	<!-- head end -->

	<!-- table star -->
	<div class="row col-lg-10">
		<div class="wrapper wrapper-content animated fadeInUp">
			<div class="ibox">
				<div class="ibox-title">
					<h5>{{ source_system }}公司-新增检核规则</h5>
					<div class="ibox-tools rboor">
						<!-- <a href="javascript:void(0);" id="commit" onclick="fun_commit()" class="btn btn-primary btn-xs p310"><i class="im-reply"></i> 提交</a> -->
						<a href="#" id="commit" class="btn btn-primary btn-xs p310"><i class="im-reply"></i> 提交</a>
					</div>
				</div>

				<div class="ibox-content">
					<table class="table table-hover">
						<tr>
							<td style="width: 150px;">
								<label class="form-label">数据标准</label>
							</td>
							<td>
								<input id="check_item" type="text" class="form-control" style="width: 400px;">
							</td>
						</tr>
						
						<tr>
							<td>
								<label class="form-label">目标表</label>
							</td>
							<td>
								<input id="target_table" type="text" class="form-control" style="width: 400px;">
							</td>
						</tr>

						<tr>
							<td>
								<label class="form-label">是否风险集市</label>
							</td>
							<td>
								<select id="risk_market" class="selectpicker">
									<option value="是">是</option>
									<option value="否">否</option>
								</select>
							</td>
						</tr>

						<tr>
							<td>
								<label class="form-label">问题分类</label>
							</td>
							<td>
								<input id="problem_type" type="text" class="form-control" style="width: 400px;">
							</td>
						</tr>

						<tr>
							<td>
								<label class="form-label">源系统数据库</label>
							</td>
							<td style="width: 150px;">
								<select id="db" class="selectpicker form-control" disabled>
							</td>
							<td>
								<button class="btn btn-primary btn-sm" onclick="QueryDB();">查询</button>
							</td>
						</tr>

						<tr>
							<td>
								<label class="form-label">检核逻辑</label>
							</td>
							<td colspan="2">
								<textarea id="code" name="code" type="text" class="form-control"></textarea>
							</td>
						</tr>

						<tr>
							<td>
								<label class="form-label">备注</label>
							</td>
							<td colspan="2">
								<textarea id="note" type="text" class="form-control" style="width: 800px;"></textarea>
							</td>
						</tr>

						<tr>
							<td>
								<label class="form-label">状态</label>
							</td>
							<td>
								<select id="status" class="selectpicker" >
									<option value="已启用">已启用</option>
									<option value="已停用">已停用</option>
								</select>
							</td>
						</tr>
					</table>
				</div>
			</div>
		</div>
	</div>
	<!-- table end -->
	<footer class="navbar-fixed-bottom" style="line-height: 10px;font-size:13px;">
		<div class="footer">
			© 2019 Hyhyhyhyhyhyh
		</div>
	</footer>

	<script src="/static/js/jquery/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="/static/CodeMirror/lib/codemirror.js"></script>
	<script src="/static/CodeMirror/mode/sql.js"></script>
	<script src="/static/js/sweetalert.min.js"></script>
	<script src="https://cdn.bootcss.com/bootstrap-select/2.0.0-beta1/js/bootstrap-select.min.js"></script>


	<script>
		var company = "{{ source_system }}";

		function QueryDB(){
			$.ajax({
				type: "GET",
					url: "../../api/backend/database/query",
					data: {},
					success: function (result) {
						// 根据公司名从接口数据获取对应的数据库名
						let db = [];
						for(let i in result.data.company){
							if(result.data.company[i] == company){
								db.push(result.data.alias[i]);
							}
						}

						// 设置显示内容
						for(i of db){
							$("#db").append($("<option value='"+i+"'>"+i+"</option>"));
						}
						//取消禁用
						$('#db').prop('disabled', false);
						$("#db").selectpicker("refresh");
					}
			})
		}

		$(function () {
			// CodeMirror编辑框
			var textarea = document.getElementById('code');
			var editor = CodeMirror.fromTextArea(textarea, {
				lineNumbers: true,
				autofocus: true,
				mode: 'text/x-plsql',
				theme: 'eclipse',
				matchBrackets: true,
				autoCloseBrackets: true,
				extraKeys: {
					"Ctrl": "autocomplete"
				},
			});
			editor.setSize('1000px', 'auto');


			// 提交修改
			$("#commit").on("click", function () {
				//获取检核逻辑代码框中修改后的value
				editor.save();
				var code = document.getElementById("code").value;
				var code = editor.getValue();

				//获取每个标签中的value,更新至数据库中
				var check_item = document.getElementById("check_item").value;
				var target_table = document.getElementById("target_table").value;
				var select_risk_market = document.getElementById("risk_market");
				var risk_market = select_risk_market.value;
				var problem_type = document.getElementById("problem_type").value;
				var db = document.getElementById("db").value;
				var note = document.getElementById("note").value;
				var select_status = document.getElementById("status");
				var status = select_status.value;
				//更新数据库
				$.ajax({
					type: "POST",
					url: "../../api/check/rule/add",
					data: {
						source_system: "{{ source_system }}",
						check_item: check_item,
						target_table: target_table,
						risk_market: risk_market,
						problem_type: problem_type,
						db: db,
						code: code,
						note: note,
						status: status,
					},
					success: function (data) {
						console.log(data);
						alert("检核规则添加成功，正在返回上一页...");
						window.location.replace(
							'../rule_list?name={{ source_system }}&risk_market=');
					},
					error: function (e) {
						console.log(e);
						alert("发生错误");
					}
				})
			});
		});
	</script>

</body>

</html>